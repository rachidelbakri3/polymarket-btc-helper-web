<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>BTC Up/Down — Hybrid</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#121212">
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<style>
  :root{
    --bg:#121212;--panel:#1e1e1e;--border:#2a2a2a;--text:#e9e9e9;--muted:#a8a8a8;
    --green:#4caf50;--red:#ef5350;--amber:#ffca28;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .page{min-height:100svh;display:flex;flex-direction:column;gap:12px;
    padding:16px;box-sizing:border-box;padding-bottom:calc(20px + env(safe-area-inset-bottom))}
  .title{margin:0 2px 2px;font-size:22px;font-weight:800;letter-spacing:.2px}
  .sub{margin:0 2px 8px;color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  .kpi{background:var(--panel);border:1px solid var(--border);border-radius:14px;
    padding:14px 16px;display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px}
  .kpi span{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.5px}
  .kpi b{font-size:18px;font-weight:800}
  .pos{color:var(--green)} .neg{color:var(--red)} .warn{color:var(--amber)}
  .gapPos{color:var(--green);font-weight:900} .gapNeg{color:var(--red);font-weight:900}
  @media (max-width:420px){.kpi{padding:12px 14px}.kpi b{font-size:17px}}
  .foot{margin-top:6px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
  <div class="page">
    <h1 class="title">BTC Up/Down — Hybrid</h1>
    <div class="sub">Live from Binance · Hour window (ET)</div>

    <div class="grid">
      <div class="kpi"><span>Price</span><b id="price">—</b></div>
      <div class="kpi"><span>Price to Beat</span><b id="ptb">—</b></div>
      <div class="kpi"><span>Time Left</span><b id="timeLeft">—</b></div>
      <div class="kpi"><span>Gap to Beat ($)</span><b id="gap">—</b></div>
      <div class="kpi"><span>Expected Move ($)</span><b id="expMove">—</b></div>
      <div class="kpi"><span>Strength (%)</span><b id="strength">—</b></div>
      <div class="kpi"><span>Up %</span><b id="upPct" class="pos">—</b></div>
      <div class="kpi"><span>Down %</span><b id="downPct" class="neg">—</b></div>
    </div>

    <div class="foot" id="stamp">—</div>
  </div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}

const { DateTime } = luxon;
let price=null, ptb=null, sigmaAnn=null;

function getHourWindowET(){
  const nowET = DateTime.now().setZone('America/New_York');
  const startET = nowET.startOf('hour');
  const endET = startET.plus({hours:1});
  return { startET, endET, nowET };
}

async function fetchPTB(){
  const { startET } = getHourWindowET();
  const startMsUTC = startET.toUTC().toMillis();
  const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&startTime=${startMsUTC}&limit=1`;
  const r = await fetch(url);
  const j = await r.json();
  if(Array.isArray(j) && j.length) ptb = parseFloat(j[0][1]); // open
}

async function fetchCloses(mins){
  const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=${mins}`;
  const r = await fetch(url); const j = await r.json();
  return j.map(c=>+c[4]); // close
}
function stdDev(a){ const m=a.reduce((x,y)=>x+y,0)/a.length;
  return Math.sqrt(a.reduce((s,v)=>s+(v-m)*(v-m),0)/a.length);
}
function annualizedVolFromCloses(closes){
  const rets=[]; for(let i=1;i<closes.length;i++) rets.push(Math.log(closes[i]/closes[i-1]));
  const sigmaPerMin = stdDev(rets); // log-return stdev per minute
  return sigmaPerMin * Math.sqrt(525600); // minutes/year
}
async function fetchHybridVol(){
  try{
    const s5  = await fetchCloses(5);
    const s60 = await fetchCloses(60);
    const v5  = annualizedVolFromCloses(s5);
    const v60 = annualizedVolFromCloses(s60);
    sigmaAnn = 0.7*v5 + 0.3*v60;
  }catch(e){ /* ignore */ }
}

function expectedMove(S, sigmaAnn, secsLeft){
  const T = Math.max(0, secsLeft) / 31536000; // seconds/year
  return S * sigmaAnn * Math.sqrt(T);
}
function normCdf(z){
  const sign=z<0?-1:1, x=Math.abs(z)/Math.sqrt(2), t=1/(1+0.3275911*x);
  const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429;
  const y=1-(((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t)*Math.exp(-x*x); const erf=sign*y; return 0.5*(1+erf);
}

const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');
ws.onmessage = e => { const d = JSON.parse(e.data); price = parseFloat(d.p); render(); };

function render(){
  const priceEl = document.getElementById('price');
  const ptbEl   = document.getElementById('ptb');
  const gapEl   = document.getElementById('gap');
  const emEl    = document.getElementById('expMove');
  const strEl   = document.getElementById('strength');
  const upEl    = document.getElementById('upPct');
  const dnEl    = document.getElementById('downPct');
  const stampEl = document.getElementById('stamp');

  if(price!==null) priceEl.textContent = price.toFixed(2);
  if(ptb!==null)   ptbEl.textContent   = ptb.toFixed(2);

  const { endET, nowET } = getHourWindowET();
  const secsLeft = Math.max(0, Math.floor(endET.diff(nowET,'seconds').seconds));
  const mm = String(Math.floor(secsLeft/60)).padStart(2,'0');
  const ss = String(secsLeft%60).padStart(2,'0');
  document.getElementById('timeLeft').textContent = `${mm}:${ss}`;

  if(price!==null && ptb!==null){
    const gap = price - ptb;
    gapEl.textContent = `${gap>=0?'+':''}${gap.toFixed(2)}`;
    gapEl.className = gap>=0 ? 'gapPos' : 'gapNeg';

    if(sigmaAnn!==null){
      const em = expectedMove(price, sigmaAnn, secsLeft);
      emEl.textContent = em.toFixed(2);

      const gapAbs = Math.abs(gap);
      if(em > gapAbs*1.1) emEl.className='pos';
      else if(em < gapAbs*0.9) emEl.className='neg';
      else emEl.className='warn';

      let strength = (gapAbs===0) ? (em/price)*100 : (em/gapAbs)*100;
      strEl.textContent = isFinite(strength) ? strength.toFixed(1)+'%' : '∞';
      if(strength>110) strEl.className='pos';
      else if(strength<90) strEl.className='neg';
      else strEl.className='warn';

      let pUp,pDown;
      if(em < 1e-6){ pUp=0.5; pDown=0.5; }
      else{
        const z = (ptb - price) / em;
        pUp = Math.max(0.01, Math.min(0.99, 1 - normCdf(z)));
        pDown = 1 - pUp;
      }
      upEl.textContent = (pUp*100).toFixed(1)+'%';
      dnEl.textContent = (pDown*100).toFixed(1)+'%';
      upEl.className = 'pos'; dnEl.className='neg';
    }
  }

  const t = new Date().toISOString().replace('T',' ').slice(0,19);
  stampEl.textContent = `Last update: ${t} UTC · WebSocket: Binance · TZ: America/New_York (ET)`;
}

setInterval(fetchHybridVol, 5000);
setInterval(fetchPTB, 3600000);
fetchHybridVol(); fetchPTB(); render();
</script>
</body>
</html>
