<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Polymarket BTC Helper (Web) â€” Black-Scholes</title>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;}
  body{font-family:system-ui,Arial; background:var(--bg); color:var(--text); margin:0; padding:24px;}
  h1{font-size:22px;text-align:center;margin:0 0 14px}
  .wrap{max-width:540px;margin:0 auto}
  .card{background:var(--card);border-radius:14px;padding:16px}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #374151;background:#0b1020;color:var(--text)}
  button{border:0;background:#2563eb;font-weight:700;margin-top:12px;cursor:pointer}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kpi{display:grid;grid-template-columns:1fr auto;gap:6px;padding:10px;border-radius:10px;background:#0b1020;margin-top:10px}
  .kpi b{font-size:16px}
  .foot{margin-top:10px;font-size:12px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <h1>BTC Up/Down Helper â€” Black-Scholes</h1>
  <div class="card">
    <div class="row">
      <div class="kpi"><span>BTC (USDT)</span><b id="btcPrice">â€”</b></div>
      <div class="kpi"><span>Minutes Left (ET)</span><b id="minsLeft">â€”</b></div>
    </div>

    <div class="kpi"><span>Price to Beat (1h open, ET)</span><b id="ptb">â€”</b></div>
    <div class="row">
      <div class="kpi"><span>Gap to Beat ($)</span><b id="gapUSD">â€”</b></div>
      <div class="kpi"><span>Volatility $/min (1m STD)</span><b id="volDol">â€”</b></div>
    </div>

    <div class="row">
      <div class="kpi"><span>Expected Move ($)</span><b id="emUSD">â€”</b></div>
      <div class="kpi"><span>Expected Move (%)</span><b id="emPct">â€”</b></div>
    </div>

    <label>Current Up Price (from Polymarket)</label>
    <input id="upPrice" type="number" step="0.01" placeholder="e.g. 0.62 (62Â¢)" />
    <button id="calcBtn">Recalculate</button>

    <div class="row">
      <div class="kpi"><span>Up %</span><b id="upPct">â€”</b></div>
      <div class="kpi"><span>Down %</span><b id="downPct">â€”</b></div>
    </div>
    <div class="kpi"><span>Signal</span><b id="signal">â€”</b></div>

    <div class="foot" id="stamp">â€”</div>
    <div class="foot">Live price: Binance WebSocket Â· Klines 1m/1h: Binance REST Â· Times in America/New_York (ET)</div>
  </div>
</div>

<script>
const { DateTime } = luxon;
const fmt = (n,d=2)=>Number.isFinite(n)?n.toFixed(d):"â€”";
const MINUTES_PER_YEAR = 525600;         // 365*24*60
const VOL_WINDOW_MINS  = 60;             // Ù†Ø§ÙØ°Ø© Ø­Ø³Ø§Ø¨ STD (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡Ø§)
const NEUTRAL_BAND     = 0.15;           // Ø­ÙŠØ§Ø¯ Ù…Ù‚Ø§Ø¨Ù„ Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚
let state = {
  price: null,            // Ø³Ø¹Ø± Ù„Ø­Ø¸ÙŠ Ù…Ù† WebSocket
  ptb: null,              // Ø§ÙØªØªØ§Ø­ Ø§Ù„Ø³Ø§Ø¹Ø© (ET)
  minsLeft: 0,            // Ø¯Ù‚Ø§Ø¦Ù‚ Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø¬Ø§Ø±ÙŠØ© (ET)
  sigmaDollarPerMin: null,// STD(Î” close_1m) Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±/Ø¯Ù‚ÙŠÙ‚Ø©
  sigmaAnnual: null,      // Ø³Ù†ÙˆÙŠ (Ù†Ø³Ø¨Ø©)
  emUSD: null,            // Expected Move Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±
  emPct: null,            // Expected Move Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© %
  currHourStartUTCms: null,
  lastVolMinute: null
};

/* ====== ÙˆÙ‚Øª Ø§Ù„Ø³Ø§Ø¹Ø© (ET) ====== */
function getHourWindowET(){
  const nowET   = DateTime.now().setZone('America/New_York');
  const startET = nowET.startOf('hour');
  const endET   = startET.plus({hours:1});
  return {
    startMsUTC: startET.toUTC().toMillis(),
    minsLeft: Math.max(0, Math.floor(endET.diff(nowET,'minutes').minutes))
  };
}

/* ====== REST ====== */
async function fetchHourOpen(startMs){
  const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&startTime=${startMs}&limit=1`;
  const r = await fetch(url); const j = await r.json();
  return (Array.isArray(j)&&j.length)? parseFloat(j[0][1]) : null; // open
}
async function fetch1mCloses(limit=VOL_WINDOW_MINS+1){
  const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=${limit}`;
  const r = await fetch(url); const data = await r.json();
  if(!Array.isArray(data)||data.length<2) return null;
  return data.map(k=>+k[4]); // Ø¥ØºÙ„Ø§Ù‚Ø§Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
}

/* ====== STD(Î” close_1m) Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±/Ø¯Ù‚ÙŠÙ‚Ø© ====== */
function stdPopulation(arr){
  if(!arr || arr.length<2) return null;
  const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
  const varp = arr.reduce((s,x)=>s+(x-mean)*(x-mean),0)/arr.length;
  return Math.sqrt(varp);
}
function computeDollarVolPerMin(closes){
  const diffs = [];
  for(let i=1;i<closes.length;i++) diffs.push(closes[i]-closes[i-1]);
  return stdPopulation(diffs); // $/min
}

/* ====== Black-Scholes EM ====== */
function computeBS_ExpectedMove(S, sigmaDolPerMin, minsLeft){
  if(!(S>0) || !(sigmaDolPerMin>0)) return {sigmaAnn:null, emUSD:null, emPct:null};
  const sigmaAnn = (sigmaDolPerMin / S) * Math.sqrt(MINUTES_PER_YEAR); // Ù†Ø³Ø¨Ø© Ø³Ù†ÙˆÙŠØ©
  const T = minsLeft / MINUTES_PER_YEAR;                                // Ø³Ù†ÙˆØ§Øª
  const emUSD = S * sigmaAnn * Math.sqrt(T);                            // $
  const emPct = (emUSD / S) * 100;                                      // %
  return {sigmaAnn, emUSD, emPct};
}

/* ====== WebSocket Ù„Ù„Ø³Ø¹Ø± ====== */
function startPriceWS(){
  try{
    const ws = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@trade");
    ws.onmessage = (ev)=>{
      const data = JSON.parse(ev.data);
      const price = parseFloat(data.p);
      if(Number.isFinite(price)){
        state.price = price;
        // Ù…Ø¹ ÙƒÙ„ ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø±ØŒ Ø­Ø¯Ù‘Ø« EM Ø¥Ù† ÙƒØ§Ù†Øª Ïƒ $/min Ù…ÙˆØ¬ÙˆØ¯Ø©
        if(state.sigmaDollarPerMin!=null){
          const {sigmaAnn, emUSD, emPct} =
            computeBS_ExpectedMove(state.price, state.sigmaDollarPerMin, state.minsLeft);
          state.sigmaAnnual = sigmaAnn; state.emUSD = emUSD; state.emPct = emPct;
        }
        render();
      }
    };
    ws.onclose = ()=> setTimeout(startPriceWS, 1500);
  }catch{ setTimeout(startPriceWS, 3000); }
}

/* ====== ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ø¬Ø¯ÙˆÙ„Ø© ====== */
async function tickSecond(){
  const {startMsUTC, minsLeft} = getHourWindowET();
  state.minsLeft = minsLeft;

  // Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø³Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø§Ø¬Ù„Ø¨ PTB Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
  if (state.currHourStartUTCms !== startMsUTC){
    state.currHourStartUTCms = startMsUTC;
    state.ptb = await fetchHourOpen(startMsUTC);
  }

  // Ø­Ø¯Ù‘Ø« EM Ù…Ø¹ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù† ØªÙˆÙØ±Øª Ïƒ $/min ÙˆØ³Ø¹Ø±
  if(state.price!=null && state.sigmaDollarPerMin!=null){
    const {sigmaAnn, emUSD, emPct} =
      computeBS_ExpectedMove(state.price, state.sigmaDollarPerMin, state.minsLeft);
    state.sigmaAnnual = sigmaAnn; state.emUSD = emUSD; state.emPct = emPct;
  }
  render();
}

async function tickMinuteWatcher(){
  const nowMin = Math.floor(Date.now()/60000);
  if (state.lastVolMinute === nowMin) return;
  state.lastVolMinute = nowMin;

  // Ø§Ø­Ø³Ø¨ STD(Î” close_1m) Ù„Ù†Ø§ÙØ°Ø© VOL_WINDOW_MINS
  const closes = await fetch1mCloses(VOL_WINDOW_MINS+1);
  const volDol = closes ? computeDollarVolPerMin(closes) : null;
  if (volDol!=null) state.sigmaDollarPerMin = volDol;

  // Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ïƒ $/minØŒ Ø§Ø­Ø³Ø¨ EM ÙÙˆØ±Ù‹Ø§ Ø¥Ù† Ø§Ù„Ø³Ø¹Ø± Ù…ØªØ§Ø­
  if(state.price!=null && state.sigmaDollarPerMin!=null){
    const {sigmaAnn, emUSD, emPct} =
      computeBS_ExpectedMove(state.price, state.sigmaDollarPerMin, state.minsLeft);
    state.sigmaAnnual = sigmaAnn; state.emUSD = emUSD; state.emPct = emPct;
  }
  render();
}

/* ====== Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª ÙˆØ¥Ø´Ø§Ø±Ø© (Ù„ÙˆØ¬Ø³ØªÙŠÙƒ Ø¨Ø³ÙŠØ·) ====== */
function recomputeProbs(){
  const S = state.price ?? 0;
  const gap = (state.ptb ?? S) - S;          // Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±
  const m = parseFloat(document.getElementById('upPrice').value);
  const market = isNaN(m)? 0.5 : m;

  // Ø§Ø³ØªØ®Ø¯Ù… EM$ ÙƒÙ…Ù‚ÙŠØ§Ø³ Ù„Ù„Ø­Ø³Ø§Ø³ÙŠØ©ØŒ Ù…Ø¹ Ø£Ø±Ø¶ÙŠØ© ØµØºÙŠØ±Ø© Ù„ØªÙØ§Ø¯ÙŠ 100%/0%
  const scale = Math.max(1e-6, state.emUSD ?? (S*0.0005)); // ~0.05%
  const k = 0.85;
  const x = gap / (k * scale);
  const up = 1/(1+Math.exp(-x));
  const down = 1-up;
  const edge = up - market;
  let sig = "âšª Neutral";
  if (edge > NEUTRAL_BAND) sig = "ğŸŸ¢ Buy Up";
  else if (edge < -NEUTRAL_BAND) sig = "ğŸ”´ Sell Up";

  document.getElementById('upPct').textContent = (up*100).toFixed(1)+'%';
  document.getElementById('downPct').textContent = (down*100).toFixed(1)+'%';
  document.getElementById('signal').textContent = sig;
}

/* ====== Ø¹Ø±Ø¶/Render ====== */
function render(){
  // Minutes Left (ET)
  document.getElementById('minsLeft').textContent = state.minsLeft;

  // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
  document.getElementById('btcPrice').textContent = fmt(state.price,2);

  // PTB
  document.getElementById('ptb').textContent = state.ptb!=null ? fmt(state.ptb,2) : 'â€”';

  // Gap to Beat
  const gap = (state.ptb!=null && state.price!=null) ? (state.ptb - state.price) : null;
  document.getElementById('gapUSD').textContent = (gap==null)?'â€”':((gap>=0?'+':'')+fmt(gap,2));

  // Vol $/min Ùˆ EM
  document.getElementById('volDol').textContent = state.sigmaDollarPerMin!=null ? fmt(state.sigmaDollarPerMin,2) : 'â€”';
  document.getElementById('emUSD').textContent  = state.emUSD!=null ? fmt(state.emUSD,2) : 'â€”';
  document.getElementById('emPct').textContent  = state.emPct!=null ? fmt(state.emPct,2)+'%' : 'â€”';

  // Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª
  recomputeProbs();

  const t = new Date().toISOString().replace('T',' ').slice(0,19);
  document.getElementById('stamp').textContent = `Last update: ${t} UTC | EM via Black-Scholes`;
}

/* ====== BOOT ====== */
document.getElementById('calcBtn').addEventListener('click', render);

(async function boot(){
  // PTB Ø£ÙˆÙ„ Ù…Ø±Ø©
  const {startMsUTC, minsLeft} = getHourWindowET();
  state.currHourStartUTCms = startMsUTC;
  state.minsLeft = minsLeft;
  state.ptb = await fetchHourOpen(startMsUTC);

  // Ïƒ $/min Ø£ÙˆÙ„ÙŠØ©
  await tickMinuteWatcher();

  // WebSocket Ù„Ù„Ø³Ø¹Ø±
  startPriceWS();

  // ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©: Ø­Ø¯Ù‘Ø« Ø§Ù„ÙˆÙ‚Øª + EM
  setInterval(tickSecond, 1000);

  // Ø±Ø§Ù‚Ø¨ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ: Ø¥Ø°Ø§ Ø¯Ø®Ù„Ù†Ø§ Ø¯Ù‚ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø¯Ù‘Ø« Ïƒ $/min
  setInterval(tickMinuteWatcher, 5000);

  render();
})();
</script>
</body>
</html>
