<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BTC Up/Down — BS Only (MM:SS)</title>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#111827;--panel:#0b1020;--text:#e5e7eb;--muted:#9ca3af;--green:#22c55e;--red:#ef4444;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial;padding:22px}
  h1{margin:0 0 14px;text-align:center}
  .card{max-width:640px;margin:0 auto;background:var(--card);border-radius:14px;padding:16px}
  .row{display:flex;justify-content:space-between;gap:8px;background:var(--panel);border-radius:12px;padding:12px;margin-top:10px}
  .label{color:var(--muted)}
  .val{font-weight:700}
  .green{color:var(--green)}
  .red{color:var(--red)}
  .foot{color:var(--muted);font-size:12px;text-align:center;margin-top:10px}
</style>
</head>
<body>
<h1>BTC Up/Down — Black-Scholes Only</h1>

<div class="card">
  <div class="row"><span class="label">سعر BTC</span><span class="val" id="btc">—</span></div>
  <div class="row"><span class="label">Price to Beat</span><span class="val" id="ptb">—</span></div>

  <div class="row"><span class="label">Expected Move ($)</span><span class="val" id="em">—</span></div>

  <div class="row"><span class="label">الوقت المتبقي (ET)</span><span class="val" id="mins">—</span></div>
  <div class="row"><span class="label">Gap to Beat ($)</span><span class="val" id="gap">—</span></div>

  <div class="row"><span class="label">Up %</span><span class="val" id="upPct">—</span></div>
  <div class="row"><span class="label">Down %</span><span class="val" id="downPct">—</span></div>

  <div class="foot" id="stamp">Initializing…</div>
  <div class="foot">المصدر: Binance WebSocket · الكلاينز: 1m/1h (REST) · التوقيت: America/New_York (ET)</div>
</div>

<script>
const { DateTime } = luxon;
const fmt = (n,d=2)=>Number.isFinite(n)?n.toFixed(d):"—";

// إعدادات
const LOOKBACK_MIN = 60;       // نافذة التذبذب بالدقائق (يمكن تغييرها)
const SEC_UPDATE_MS = 200;     // سرعة تحديث الوقت
const VOL_REFRESH_MS = 4000;   // كل كم نحدّث التذبذب
const EPS = 1e-9;

let S = null;                  // السعر الحالي
let PTB = null;                // سعر الافتتاح للساعة (هدف الرهان)
let secondsLeft = 0;           // الوقت المتبقي بالثواني
let sigmaDollarPerMin = null;  // std(diff(close_1m)) بالدولار لكل دقيقة
let emBS = null;               // Expected Move بالدولار (Black-Scholes فقط)
let currHourStartUTCms = null;
let lastVolRefreshAt = 0;

/* ========== أدوات الوقت (ET) ========== */
function getETWindow(){
  const nowET = DateTime.now().setZone('America/New_York');
  const start = nowET.startOf('hour');
  const end   = start.plus({hours:1});
  const secsLeft = Math.max(0, Math.floor(end.diff(nowET,'seconds').seconds));
  return { startMsUTC: start.toUTC().toMillis(), secsLeft };
}
function toMMSS(secs){
  const m = Math.floor(secs/60);
  const s = secs % 60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* ========== REST ========== */
async function fetchHourOpen(startMs){
  const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&startTime=${startMs}&limit=1`;
  const r = await fetch(url);
  const j = await r.json();
  return (Array.isArray(j) && j.length) ? +j[0][1] : null;  // open
}
async function fetch1mKlines(limit){
  const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=${limit}`;
  const r = await fetch(url);
  const j = await r.json();
  return Array.isArray(j) ? j : null;
}

/* ========== إحصاءات ========== */
function stdPopulation(arr){
  if(!arr || arr.length < 2) return null;
  const mean = arr.reduce((a,b)=>a+b,0) / arr.length;
  const varc = arr.reduce((s,x)=> s + (x-mean)*(x-mean), 0) / arr.length;
  return Math.sqrt(varc);
}
function dollarVolPerMinFromCloses(closes){
  const diffs = [];
  for(let i=1;i<closes.length;i++) diffs.push(closes[i]-closes[i-1]);
  return stdPopulation(diffs);
}

/* ========== CDF طبيعي ========== */
function normCdf(z){
  // تقريب سريع
  const t = 1/(1+0.2316419*Math.abs(z));
  const d = 0.3989423*Math.exp(-0.5*z*z);
  let p = 1 - d*(1.330274*t - 1.821256*t**2 + 1.781478*t**3 - 0.356564*t**4 + 0.3193815*t**5);
  return z>=0 ? p : 1-p;
}

/* ========== WebSocket للسعر ========== */
function startWS(){
  const ws = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@trade");
  ws.onmessage = (ev)=>{
    const { p } = JSON.parse(ev.data);
    const price = parseFloat(p);
    if(Number.isFinite(price)){
      S = price;
      recomputeEM();
      render();
    }
  };
  ws.onclose = ()=> setTimeout(startWS, 1200);
}

/* ========== حساب EM (Black-Scholes فقط) ==========
   EM_BS = sigma_$perMin * sqrt(minutes_left)
   ومع اقتراب الوقت لنهاية الساعة → EM→0 تلقائياً
*/
function recomputeEM(){
  if(sigmaDollarPerMin!=null){
    const minutesLeft = Math.max(0, secondsLeft/60);
    emBS = sigmaDollarPerMin * Math.sqrt(minutesLeft);
  }else{
    emBS = null;
  }
}

/* ========== التحديثات الدورية ========== */
async function tickTime(){
  const { startMsUTC, secsLeft } = getETWindow();
  secondsLeft = secsLeft;

  // إذا تغيّرت الساعة، حدّث PTB
  if(currHourStartUTCms !== startMsUTC){
    currHourStartUTCms = startMsUTC;
    PTB = await fetchHourOpen(startMsUTC);
  }

  recomputeEM();
  render();
}

async function tickVol(){
  const now = Date.now();
  if(now - lastVolRefreshAt < VOL_REFRESH_MS) return;
  lastVolRefreshAt = now;

  const k = await fetch1mKlines(Math.max(LOOKBACK_MIN+1, 61));
  if(k){
    const closes = k.map(x=>+x[4]);
    const vol = dollarVolPerMinFromCloses(closes);
    if(vol!=null) sigmaDollarPerMin = vol;
  }
  recomputeEM();
  render();
}

/* ========== واجهة المستخدم ========== */
function render(){
  const btcEl = document.getElementById('btc');
  const ptbEl = document.getElementById('ptb');
  const minsEl= document.getElementById('mins');
  const gapEl = document.getElementById('gap');
  const emEl  = document.getElementById('em');
  const upEl  = document.getElementById('upPct');
  const dnEl  = document.getElementById('downPct');

  btcEl.textContent = fmt(S,2);
  ptbEl.textContent = fmt(PTB,2);
  minsEl.textContent= toMMSS(secondsLeft);

  // Gap ملوّن
  if(S!=null && PTB!=null){
    const gap = S - PTB;
    gapEl.textContent = `${gap>0?'+':''}${fmt(gap,2)}`;
    gapEl.className = `val ${gap>0?'green':'red'}`;
    btcEl.className = `val ${gap>0?'green':'red'}`;
  }else{
    gapEl.textContent = '—'; gapEl.className='val'; btcEl.className='val';
  }

  emEl.textContent = emBS!=null ? fmt(emBS,2) : '—';

  // Up / Down
  if(S!=null && PTB!=null){
    // إذا EM قريب من الصفر (آخر الثواني)، حدّد الاحتمال مباشرة من موقع السعر
    if(emBS==null || emBS < EPS){
      const up = S >= PTB ? 100 : 0;
      const dn = 100 - up;
      upEl.textContent = up.toFixed(1)+'%';
      dnEl.textContent = dn.toFixed(1)+'%';
      upEl.className = up>dn ? 'val green':'val';
      dnEl.className = dn>up ? 'val red':'val';
    }else{
      const z = (PTB - S)/emBS;
      const p = 1 - normCdf(z); // احتمال الإغلاق ≥ PTB
      const upPct = p*100, downPct = (1-p)*100;
      upEl.textContent = upPct.toFixed(1)+'%';
      dnEl.textContent = downPct.toFixed(1)+'%';
      upEl.className = upPct>downPct ? 'val green' : 'val';
      dnEl.className = downPct>upPct ? 'val red'   : 'val';
    }
  }else{
    upEl.textContent='—'; dnEl.textContent='—'; upEl.className='val'; dnEl.className='val';
  }

  document.getElementById('stamp').textContent =
    'Last update: ' + new Date().toISOString().replace('T',' ').slice(0,19) + ' UTC';
}

/* ========== تشغيل ========== */
(async function(){
  const { startMsUTC, secsLeft } = getETWindow();
  currHourStartUTCms = startMsUTC;
  secondsLeft = secsLeft;

  PTB = await fetchHourOpen(startMsUTC);
  await tickVol();      // احسب التذبذب أول مرة
  startWS();

  setInterval(tickTime, SEC_UPDATE_MS);   // تحديث الوقت/EM بالثواني
  setInterval(tickVol, 1500);             // تحدّث التذبذب باستمرار
  render();
})();
</script>
</body>
</html>
