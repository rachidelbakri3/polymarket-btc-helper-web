<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BTC Up/Down — Hybrid Vol (BS seconds)</title>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#111827;--panel:#0b1020;--text:#e5e7eb;--muted:#9ca3af;--green:#22c55e;--red:#ef4444;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial;padding:22px}
  h1{margin:0 0 14px;text-align:center}
  .card{max-width:640px;margin:0 auto;background:var(--card);border-radius:14px;padding:16px}
  .row{display:flex;justify-content:space-between;gap:8px;background:var(--panel);border-radius:12px;padding:12px;margin-top:10px}
  .label{color:var(--muted)}
  .val{font-weight:700}
  .green{color:var(--green)}
  .red{color:var(--red)}
  .foot{color:var(--muted);font-size:12px;text-align:center;margin-top:10px}
</style>
</head>
<body>
<h1>BTC Up/Down — Black-Scholes (seconds) · Hybrid Vol</h1>

<div class="card">
  <div class="row"><span class="label">سعر BTC</span><span class="val" id="btc">—</span></div>
  <div class="row"><span class="label">Price to Beat</span><span class="val" id="ptb">—</span></div>

  <div class="row"><span class="label">Expected Move ($)</span><span class="val" id="em">—</span></div>

  <div class="row"><span class="label">الوقت المتبقي (ET)</span><span class="val" id="mins">—</span></div>
  <div class="row"><span class="label">Gap to Beat ($)</span><span class="val" id="gap">—</span></div>

  <div class="row"><span class="label">% Up</span><span class="val" id="upPct">—</span></div>
  <div class="row"><span class="label">% Down</span><span class="val" id="downPct">—</span></div>

  <div class="foot" id="stamp">Initializing…</div>
  <div class="foot">WebSocket: Binance · REST: 1m/1h · TZ: America/New_York (ET)</div>
</div>

<script>
const { DateTime } = luxon;
const fmt=(n,d=2)=>Number.isFinite(n)?n.toFixed(d):"—";

/* ===== إعدادات مُوصى بها ===== */
const LOOKBACK_MIN_LONG  = 240;   // 4 ساعات
const LOOKBACK_MIN_SHORT = 15;    // 15 دقيقة
const LONG_WEIGHT  = 0.7;         // محافظ أكثر: 0.8 | هجومي: 0.6
const SHORT_WEIGHT = 1 - LONG_WEIGHT;

const SEC_TICK_MS    = 500;       // تحديث الواجهة/الوقت
const VOL_REFRESH_MS = 5000;      // إعادة حساب التقلب الهجين
const SECONDS_PER_YEAR = 365*24*60*60;
const MINUTES_PER_YEAR = 525600;
const EPS = 1e-9;

/* ===== حالة ===== */
let S=null, PTB=null;
let secondsLeft=0;
let sigmaAnn=null;         // التقلب السنوي النسبي (الهجين)
let emUSD=null;
let currHourStartUTCms=null;
let lastVolAt=0;

/* ===== وقت الساعة (ET) بالثواني ===== */
function getETWindow(){
  const nowET=DateTime.now().setZone('America/New_York');
  const start=nowET.startOf('hour');
  const end=start.plus({hours:1});
  return { startMsUTC:start.toUTC().toMillis(),
           secsLeft:Math.max(0, Math.floor(end.diff(nowET,'seconds').seconds)) };
}
function mmss(secs){ const m=Math.floor(secs/60), s=secs%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

/* ===== REST ===== */
async function fetchHourOpen(startMs){
  const u=`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&startTime=${startMs}&limit=1`;
  const r=await fetch(u); const j=await r.json();
  return (Array.isArray(j)&&j.length)?+j[0][1]:null;
}
async function fetch1mKlines(limit){
  const u=`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=${limit}`;
  const r=await fetch(u); const j=await r.json();
  return Array.isArray(j)?j:null;
}

/* ===== إحصاء التقلب السنوي من إغلاقات 1m (log-returns) ===== */
function stdPopulation(a){ if(!a||a.length<2) return null;
  const m=a.reduce((x,y)=>x+y,0)/a.length;
  const v=a.reduce((s,x)=>s+(x-m)*(x-m),0)/a.length;
  return Math.sqrt(v);
}
function annualizedVolFromCloses(closes){
  if(!closes || closes.length<2) return null;
  const rets=[];
  for(let i=1;i<closes.length;i++){
    const c0=closes[i-1], c1=closes[i];
    if(c0>0 && c1>0) rets.push(Math.log(c1/c0));
  }
  const sigmaPerMin = stdPopulation(rets);
  return (sigmaPerMin && sigmaPerMin>0) ? sigmaPerMin * Math.sqrt(MINUTES_PER_YEAR) : null;
}

/* ===== تقلب هجين: 4h و 15m ===== */
async function fetchSigmaAnnHybrid(){
  const [kLong, kShort] = await Promise.all([
    fetch1mKlines(Math.max(LOOKBACK_MIN_LONG+1,  61)),
    fetch1mKlines(Math.max(LOOKBACK_MIN_SHORT+1, 61)),
  ]);
  const cLong  = kLong  ? kLong.map(x=>+x[4])  : null;
  const cShort = kShort ? kShort.map(x=>+x[4]) : null;

  const sigL = cLong  ? annualizedVolFromCloses(cLong)  : null;
  const sigS = cShort ? annualizedVolFromCloses(cShort) : null;

  if(sigL && sigS)   return LONG_WEIGHT*sigL + SHORT_WEIGHT*sigS;
  if(sigL)           return sigL;
  if(sigS)           return sigS;
  return null;
}

/* ===== CDF طبيعي ===== */
function normCdf(z){
  const t=1/(1+0.2316419*Math.abs(z));
  const d=0.3989423*Math.exp(-0.5*z*z);
  let p=1-d*(1.330274*t-1.821256*t**2+1.781478*t**3-0.356564*t**4+0.3193815*t**5);
  return z>=0?p:1-p;
}

/* ===== WebSocket للسعر ===== */
function startWS(){
  const ws=new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@trade");
  ws.onmessage=(ev)=>{
    const {p}=JSON.parse(ev.data);
    const price=parseFloat(p);
    if(Number.isFinite(price)){ S=price; recomputeEM(); render(); }
  };
  ws.onclose=()=>setTimeout(startWS,1200);
}

/* ===== EM (Black-Scholes بالثواني) ===== */
function recomputeEM(){
  if(S!=null && sigmaAnn!=null){
    const T = secondsLeft/SECONDS_PER_YEAR;
    emUSD = (T>0) ? (S * sigmaAnn * Math.sqrt(T)) : 0;
  }else{ emUSD=null; }
}

/* ===== دورات ===== */
async function tickTime(){
  const {startMsUTC, secsLeft}=getETWindow();
  secondsLeft=secsLeft;
  if(currHourStartUTCms!==startMsUTC){
    currHourStartUTCms=startMsUTC;
    PTB=await fetchHourOpen(startMsUTC);
  }
  recomputeEM(); render();
}
async function tickVol(){
  const now=Date.now(); if(now-lastVolAt<VOL_REFRESH_MS) return; lastVolAt=now;
  const sig=await fetchSigmaAnnHybrid();
  if(sig!=null) sigmaAnn=sig;
  recomputeEM(); render();
}

/* ===== UI ===== */
function render(){
  const btcEl=document.getElementById('btc');
  const ptbEl=document.getElementById('ptb');
  const minsEl=document.getElementById('mins');
  const gapEl=document.getElementById('gap');
  const emEl=document.getElementById('em');
  const upEl=document.getElementById('upPct');
  const dnEl=document.getElementById('downPct');

  btcEl.textContent=fmt(S,2);
  ptbEl.textContent=fmt(PTB,2);
  minsEl.textContent=mmss(secondsLeft);

  if(S!=null && PTB!=null){
    const gap=S-PTB;
    gapEl.textContent=`${gap>0?'+':''}${fmt(gap,2)}`;
    gapEl.className=`val ${gap>0?'green':'red'}`;
    btcEl.className=`val ${gap>0?'green':'red'}`;
  }else{
    gapEl.textContent='—'; gapEl.className='val'; btcEl.className='val';
  }

  emEl.textContent = emUSD!=null ? fmt(emUSD,2) : '—';

  if(S!=null && PTB!=null){
    if(emUSD==null || emUSD<EPS){
      const up = S>=PTB ? 100 : 0, dn=100-up;
      upEl.textContent=up.toFixed(1)+'%';
      dnEl.textContent=dn.toFixed(1)+'%';
      upEl.className= up>dn ? 'val green':'val';
      dnEl.className= dn>up ? 'val red'  :'val';
    }else{
      const z=(PTB - S)/emUSD;
      const p=1 - normCdf(z);
      const upPct=p*100, downPct=(1-p)*100;
      upEl.textContent=upPct.toFixed(1)+'%';
      dnEl.textContent=downPct.toFixed(1)+'%';
      upEl.className= upPct>downPct ? 'val green':'val';
      dnEl.className= downPct>upPct ? 'val red'  :'val';
    }
  }else{
    upEl.textContent='—'; dnEl.textContent='—'; upEl.className='val'; dnEl.className='val';
  }

  document.getElementById('stamp').textContent =
    'Last update: '+new Date().toISOString().replace('T',' ').slice(0,19)+' UTC';
}

/* ===== boot ===== */
(async function(){
  const { startMsUTC, secsLeft } = getETWindow();
  currHourStartUTCms = startMsUTC;
  secondsLeft = secsLeft;

  PTB = await fetchHourOpen(startMsUTC);
  const sig0 = await fetchSigmaAnnHybrid();   // أول قيمة للتقلب
  if(sig0!=null) sigmaAnn=sig0;
  recomputeEM();

  startWS();
  setInterval(tickTime, SEC_TICK_MS);
  setInterval(tickVol, VOL_REFRESH_MS);
  render();
})();
</script>
</body>
</html>
