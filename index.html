<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BTC Up/Down â€” Black-Scholes (Smart + Controls)</title>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#111827;--panel:#0b1020;--text:#e5e7eb;--muted:#9ca3af;--btn:#2563eb;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:22px}
  h1{margin:0 0 14px;text-align:center}
  .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kpi{display:grid;grid-template-columns:1fr auto;gap:6px;background:var(--panel);border-radius:12px;padding:12px;margin-top:10px}
  .kpi b{font-size:16px}
  label{display:block;margin:10px 0 6px;color:var(--muted);font-size:13px}
  input,button{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:var(--panel);color:var(--text)}
  button{border:0;background:var(--btn);font-weight:700;cursor:pointer;margin-top:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .foot{margin-top:10px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>BTC Up/Down â€” Black-Scholes (Smart + Controls)</h1>
  <div class="card">

    <div class="grid">
      <div class="kpi"><span>BTC (USDT)</span><b id="btc">â€”</b></div>
      <div class="kpi"><span>Minutes Left (ET)</span><b id="mins">â€”</b></div>
    </div>

    <div class="kpi"><span>Price to Beat (1h open, ET)</span><b id="ptb">â€”</b></div>

    <div class="grid">
      <div class="kpi"><span>Gap to Beat ($)</span><b id="gapUSD">â€”</b></div>
      <div class="kpi"><span>Reach PTB by end (%)</span><b id="reachPTB">â€”</b></div>
    </div>

    <div class="grid">
      <div class="kpi"><span>Volatility $/min (1m STD)</span><b id="volDol">â€”</b></div>
      <div class="kpi"><span>Ïƒ annualized</span><b id="sigmaAnn">â€”</b></div>
    </div>

    <div class="grid">
      <div class="kpi"><span>Expected Move ($)</span><b id="emUSD">â€”</b></div>
      <div class="kpi"><span>Expected Move (%)</span><b id="emPct">â€”</b></div>
    </div>

    <div class="row3">
      <div>
        <label>Logistic k (Ø­Ø³Ø§Ø³ÙŠØ©)</label>
        <input id="kSens" type="number" step="0.01" value="0.85">
      </div>
      <div>
        <label>Neutral band %</label>
        <input id="neutralBand" type="number" step="0.01" value="0.15">
      </div>
      <div>
        <label>Up price (Polymarket) Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
        <input id="upPrice" type="number" step="0.01" placeholder="e.g. 0.62">
      </div>
    </div>
    <button id="applyBtn">Apply</button>

    <div class="grid">
      <div class="kpi"><span>Up %</span><b id="upPct">â€”</b></div>
      <div class="kpi"><span>Down %</span><b id="downPct">â€”</b></div>
    </div>
    <div class="kpi"><span>Signal</span><b id="signal">â€”</b></div>

    <div class="foot" id="stamp">Initializingâ€¦</div>
    <div class="foot">Live: Binance WebSocket Â· Klines 1m/1h: Binance REST Â· Times in America/New_York (ET)</div>
  </div>
</div>

<script>
const { DateTime } = luxon;
const fmt = (n,d=2)=>Number.isFinite(n)?n.toFixed(d):"â€”";
const MINUTES_PER_YEAR = 525600;
const VOL_WINDOW_MINS  = 60;

let cfg = {
  k: 0.85,            // Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠÙƒ
  neutralBand: 0.15   // Ø­ÙŠØ§Ø¯ Ù…Ù‚Ø§Ø¨Ù„ Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚
};

let S = null, PTB = null, minutesLeft = 0;
let sigmaDollarPerMin = null, sigmaAnnual = null;
let emUSD = null, emPct = null;
let currHourStartUTCms = null, lastVolMinute = null;

/* ---------- Time (ET) ---------- */
function getHourWindowET(){
  const nowET = DateTime.now().setZone('America/New_York');
  const startET = nowET.startOf('hour');
  const endET = startET.plus({hours:1});
  return { startMsUTC: startET.toUTC().toMillis(), minsLeft: Math.max(0, Math.floor(endET.diff(nowET,'minutes').minutes)) };
}

/* ---------- REST ---------- */
async function fetchHourOpen(startMs){
  const url=`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&startTime=${startMs}&limit=1`;
  const r=await fetch(url); const j=await r.json();
  return (Array.isArray(j)&&j.length)? parseFloat(j[0][1]) : null;
}
async function fetch1mCloses(limit=VOL_WINDOW_MINS+1){
  const url=`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=${limit}`;
  const r=await fetch(url); const data=await r.json();
  if(!Array.isArray(data)||data.length<2) return null;
  return data.map(k=>+k[4]);
}

/* ---------- Vol $/min ---------- */
function stdPopulation(arr){
  if(!arr||arr.length<2) return null;
  const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
  const varp = arr.reduce((s,x)=>s+(x-mean)*(x-mean),0)/arr.length;
  return Math.sqrt(varp);
}
function computeDollarVolPerMin(closes){
  const diffs=[]; for(let i=1;i<closes.length;i++) diffs.push(closes[i]-closes[i-1]);
  return stdPopulation(diffs);
}

/* ---------- Black-Scholes EM ---------- */
function computeBS_ExpectedMove(S, sigmaDolPerMin, minsLeft){
  if(!(S>0) || !(sigmaDolPerMin>0)) return {sigmaAnn:null, emUSD:null, emPct:null};
  const sigmaAnn=(sigmaDolPerMin/S)*Math.sqrt(MINUTES_PER_YEAR);
  const T=minsLeft/MINUTES_PER_YEAR;
  const emUSD=S*sigmaAnn*Math.sqrt(T);
  const emPct=(emUSD/S)*100;
  return {sigmaAnn, emUSD, emPct};
}

/* ---------- Normal CDF (approx) ---------- */
function normCdf(z){
  // Abramowitzâ€“Stegun approximation
  const t = 1 / (1 + 0.2316419 * Math.abs(z));
  const d = 0.3989423 * Math.exp(-0.5*z*z);
  let p = 1 - d * (1.330274*t - 1.821256*t**2 + 1.781478*t**3 - 0.356564*t**4 + 0.3193815*t**5);
  return z >= 0 ? p : 1 - p;
}

/* ---------- Live price ---------- */
function startWS(){
  const ws = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@trade");
  ws.onmessage = (ev)=>{
    const {p} = JSON.parse(ev.data);
    const price = parseFloat(p);
    if(Number.isFinite(price)){
      S = price;
      if(sigmaDollarPerMin!=null){
        const r = computeBS_ExpectedMove(S, sigmaDollarPerMin, minutesLeft);
        sigmaAnnual=r.sigmaAnn; emUSD=r.emUSD; emPct=r.emPct;
      }
      render();
    }
  };
  ws.onclose = ()=> setTimeout(startWS, 1500);
}

/* ---------- Schedulers ---------- */
async function tickSecond(){
  const {startMsUTC, minsLeft} = getHourWindowET();
  minutesLeft = minsLeft;
  if (currHourStartUTCms !== startMsUTC){
    currHourStartUTCms = startMsUTC;
    PTB = await fetchHourOpen(startMsUTC);
  }
  if(S!=null && sigmaDollarPerMin!=null){
    const r = computeBS_ExpectedMove(S, sigmaDollarPerMin, minutesLeft);
    sigmaAnnual=r.sigmaAnn; emUSD=r.emUSD; emPct=r.emPct;
  }
  render();
}

async function tickMinuteWatcher(){
  const nowMin = Math.floor(Date.now()/60000);
  if (lastVolMinute === nowMin) return;
  lastVolMinute = nowMin;

  const closes = await fetch1mCloses(VOL_WINDOW_MINS+1);
  const volDol = closes ? computeDollarVolPerMin(closes) : null;
  if (volDol!=null) sigmaDollarPerMin = volDol;

  if(S!=null && sigmaDollarPerMin!=null){
    const r = computeBS_ExpectedMove(S, sigmaDollarPerMin, minutesLeft);
    sigmaAnnual=r.sigmaAnn; emUSD=r.emUSD; emPct=r.emPct;
  }
  render();
}

/* ---------- Probs + Signal (with controls) ---------- */
function recomputeProbs(){
  const price = S ?? 0;
  const gap = (PTB ?? price) - price;              // $
  const marketUp = parseFloat(document.getElementById('upPrice').value);
  const market = isNaN(marketUp) ? 0.5 : marketUp;

  // Ø­Ø³Ø§Ø³ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  const k = Math.max(0.1, parseFloat(document.getElementById('kSens').value) || cfg.k);
  const neutralBand = Math.max(0, parseFloat(document.getElementById('neutralBand').value) || cfg.neutralBand);

  // Ø§Ø³ØªØ®Ø¯Ù… EM$ ÙƒÙ…Ù‚ÙŠØ§Ø³ Ù„Ù„ØªÙˆØ³ÙŠØ¹Ø› Ø£Ø±Ø¶ÙŠØ© ØµØºÙŠØ±Ø©
  const scale = Math.max(1e-6, emUSD ?? (price*0.0005));
  const x = gap / (k * scale);
  const up = 1 / (1 + Math.exp(-x));
  const down = 1 - up;
  const edge = up - market;

  const sig = edge > neutralBand ? "ðŸŸ¢ Buy Up" : edge < -neutralBand ? "ðŸ”´ Sell Up" : "âšª Neutral";

  document.getElementById('upPct').textContent   = (up*100).toFixed(1)+'%';
  document.getElementById('downPct').textContent = (down*100).toFixed(1)+'%';
  document.getElementById('signal').textContent  = sig;

  // Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ PTB Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ø§Ø¹Ø©
  let reachPct = 'â€”';
  if (emUSD!=null && emUSD>0 && price!=null && PTB!=null){
    const z = (PTB - price) / emUSD;   // Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø¹Ù„Ù‰ Ïƒ=EM$
    const prob = 1 - normCdf(z);       // P(S_T >= PTB)
    reachPct = (prob*100).toFixed(1)+'%';
  }
  document.getElementById('reachPTB').textContent = reachPct;
}

/* ---------- Render ---------- */
function render(){
  document.getElementById('btc').textContent      = fmt(S,2);
  document.getElementById('mins').textContent     = minutesLeft;
  document.getElementById('ptb').textContent      = PTB!=null ? fmt(PTB,2) : 'â€”';

  const gap = (PTB!=null && S!=null) ? (PTB - S) : null;
  document.getElementById('gapUSD').textContent   = gap==null ? 'â€”' : ((gap>=0?'+':'')+fmt(gap,2));

  document.getElementById('volDol').textContent   = sigmaDollarPerMin!=null ? fmt(sigmaDollarPerMin,2) : 'â€”';
  document.getElementById('sigmaAnn').textContent = sigmaAnnual!=null ? (sigmaAnnual*100).toFixed(2)+'%' : 'â€”';
  document.getElementById('emUSD').textContent    = emUSD!=null ? fmt(emUSD,2) : 'â€”';
  document.getElementById('emPct').textContent    = emPct!=null ? fmt(emPct,2)+'%' : 'â€”';

  recomputeProbs();

  document.getElementById('stamp').textContent =
    'Last update: ' + new Date().toISOString().replace('T',' ').slice(0,19) + ' UTC';
}

/* ---------- Boot ---------- */
document.getElementById('applyBtn').addEventListener('click', render);

(async function boot(){
  const {startMsUTC, minsLeft} = getHourWindowET();
  currHourStartUTCms = startMsUTC;
  minutesLeft = minsLeft;
  PTB = await fetchHourOpen(startMsUTC);

  await tickMinuteWatcher();  // ÙŠØ­Ø³Ø¨ vol $/min Ø£ÙˆÙ„ÙŠÙ‹Ø§ + EM

  startWS();                  // Ø³Ø¹Ø± Ù„Ø­Ø¸ÙŠ
  setInterval(tickSecond, 1000);
  setInterval(tickMinuteWatcher, 5000);

  render();
})();
</script>
</body>
</html>
