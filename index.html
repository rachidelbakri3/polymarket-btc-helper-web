<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>BTC Up/Down — Dark</title>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

<style>
  /* ======== Dark Normal Theme (fills mobile screen) ======== */
  :root{
    --bg:#121212;        /* خلفية داكنة عادية */
    --panel:#1e1e1e;     /* كروت داكنة */
    --border:#2a2a2a;    /* حدود خفيفة */
    --text:#e0e0e0;      /* نص رئيسي */
    --muted:#a9a9a9;     /* نص ثانوي */
    --green:#4caf50;     /* موجب */
    --red:#f44336;       /* سالب */
    --amber:#ffca28;     /* تحذير */
  }

  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  /* احتلال الشاشة بالكامل مع مراعاة الآمن في الهواتف */
  .page{
    min-height:100svh;
    padding:16px;
    padding-bottom:calc(16px + env(safe-area-inset-bottom));
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .title{
    margin:2px 2px 4px;
    font-size:22px;
    font-weight:700;
    color:#fff;
    letter-spacing:.2px;
  }
  .sub{
    margin:0 2px 8px;
    color:var(--muted);
    font-size:12px;
  }

  .grid{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    flex:1;                 /* تمدد لتعبئة الشاشة */
  }

  .kpi{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:14px 16px;
    display:grid;
    grid-template-columns:1fr auto;
    align-items:center;
    gap:10px;
  }
  .kpi span{
    color:var(--muted);
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.5px;
  }
  .kpi b{
    font-size:18px;
    font-weight:700;
  }

  .pos{color:var(--green)}
  .neg{color:var(--red)}
  .warn{color:var(--amber)}
  .gapPos{color:var(--green);font-weight:800}
  .gapNeg{color:var(--red);font-weight:800}

  /* تكبير الأرقام قليلًا على الشاشات الصغيرة */
  @media (max-width:420px){
    .kpi{padding:13px 14px}
    .kpi b{font-size:17px}
  }
</style>
</head>
<body>
  <div class="page">
    <h1 class="title">BTC Up/Down — Hybrid</h1>
    <div class="sub">Live from Binance · Hour window (ET)</div>

    <div class="grid">
      <div class="kpi"><span>Price</span><b id="price">—</b></div>
      <div class="kpi"><span>Price to Beat</span><b id="ptb">—</b></div>
      <div class="kpi"><span>Time Left</span><b id="timeLeft">—</b></div>
      <div class="kpi"><span>Gap to Beat ($)</span><b id="gap">—</b></div>
      <div class="kpi"><span>Expected Move ($)</span><b id="expMove">—</b></div>
      <div class="kpi"><span>Strength (%)</span><b id="strength">—</b></div>
      <div class="kpi"><span>Up %</span><b id="upPct" class="pos">—</b></div>
      <div class="kpi"><span>Down %</span><b id="downPct" class="neg">—</b></div>
    </div>
  </div>

<script>
/* ======== Logic (كما اتفقنا) ======== */
const { DateTime } = luxon;
let price=null, ptb=null, sigmaAnn=null;

function getHourWindowET(){
  const nowET = DateTime.now().setZone('America/New_York');
  const startET = nowET.startOf('hour');
  const endET = startET.plus({hours:1});
  return { startET, endET, nowET };
}

async function fetchPTB(){
  const { startET } = getHourWindowET();
  const startMsUTC = startET.toUTC().toMillis();
  const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&startTime=${startMsUTC}&limit=1`;
  const r = await fetch(url); const j = await r.json();
  if(j && j.length) ptb = parseFloat(j[0][1]);
}

async function fetchCloses(mins){
  const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=${mins}`;
  const r = await fetch(url); const j = await r.json();
  return j.map(c=>+c[4]);
}
function stdDev(a){ const m=a.reduce((x,y)=>x+y,0)/a.length;
  return Math.sqrt(a.reduce((s,v)=>s+(v-m)*(v-m),0)/a.length);
}
function annualizedVol(closes){
  const rets=[]; for(let i=1;i<closes.length;i++) rets.push(Math.log(closes[i]/closes[i-1]));
  const sigmaPerMin = stdDev(rets);            // σ_1min (log-returns)
  return sigmaPerMin * Math.sqrt(525600);      // سنويًا
}
async function fetchHybridVol(){
  const s = await fetchCloses(5);
  const l = await fetchCloses(60);
  sigmaAnn = 0.7*annualizedVol(s) + 0.3*annualizedVol(l);
}

function expectedMove(S, sigma, secsLeft){
  const T = secsLeft / 31536000;               // سنة = 365*24*3600
  return S * sigma * Math.sqrt(T);
}

/* Normal CDF (بدون Math.erf) */
function normCdf(z){
  const sign = z < 0 ? -1 : 1;
  const x = Math.abs(z) / Math.sqrt(2);
  const t = 1 / (1 + 0.3275911 * x);
  const a1=0.254829592, a2=-0.284496736, a3=1.421413741, a4=-1.453152027, a5=1.061405429;
  const y = 1 - (((((a5*t + a4)*t + a3)*t + a2)*t + a1)*t) * Math.exp(-x*x);
  const erf = sign * y;
  return 0.5 * (1 + erf);
}

/* WebSocket للسعر الحي */
const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');
ws.onmessage = e => { const d = JSON.parse(e.data); price = parseFloat(d.p); render(); };

function render(){
  if(price!==null) document.getElementById('price').textContent = price.toFixed(2);
  if(ptb!==null)   document.getElementById('ptb').textContent   = ptb.toFixed(2);

  const { endET, nowET } = getHourWindowET();
  const secsLeft = Math.max(0, Math.floor(endET.diff(nowET,'seconds').seconds));
  const mm = String(Math.floor(secsLeft/60)).padStart(2,'0');
  const ss = String(secsLeft%60).padStart(2,'0');
  document.getElementById('timeLeft').textContent = `${mm}:${ss}`;

  if(price!==null && ptb!==null){
    const gap = price - ptb;
    const gapEl = document.getElementById('gap');
    gapEl.textContent = `${gap>=0?'+':''}${gap.toFixed(2)}`;
    gapEl.className = gap>=0 ? 'gapPos' : 'gapNeg';

    if(sigmaAnn!==null){
      const em = expectedMove(price, sigmaAnn, secsLeft);
      const emEl = document.getElementById('expMove');
      emEl.textContent = em.toFixed(2);

      const gapAbs = Math.abs(gap);
      if(em > gapAbs*1.1) emEl.className='pos';
      else if(em < gapAbs*0.9) emEl.className='neg';
      else emEl.className='warn';

      // Strength %
      let strength = (gapAbs===0) ? (em/price)*100 : (em/gapAbs)*100;
      const sEl = document.getElementById('strength');
      sEl.textContent = isFinite(strength) ? strength.toFixed(1)+'%' : '∞';
      if(strength>110) sEl.className='pos';
      else if(strength<90) sEl.className='neg';
      else sEl.className='warn';

      // Up / Down %
      let pUp, pDown;
      if(em < 1e-6){ pUp=0.5; pDown=0.5; }
      else{
        const z = (ptb - price) / em;
        pUp = Math.max(0.01, Math.min(0.99, 1 - normCdf(z)));
        pDown = 1 - pUp;
      }
      document.getElementById('upPct').textContent   = (pUp*100).toFixed(1)+'%';
      document.getElementById('downPct').textContent = (pDown*100).toFixed(1)+'%';
    }
  }
}

/* تحديثات دورية */
setInterval(fetchHybridVol, 5000);     // Vol
setInterval(fetchPTB, 3600000);        // PTB كل ساعة

fetchHybridVol();
fetchPTB();
render();
</script>
</body>
</html>
