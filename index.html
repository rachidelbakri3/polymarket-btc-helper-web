<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Polymarket BTC Helper (Web)</title>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<style>
  :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;}
  body{font-family:system-ui,Arial; background:var(--bg); color:var(--text); margin:0; padding:24px;}
  h1{font-size:22px;text-align:center;margin:0 0 14px}
  .wrap{max-width:520px;margin:0 auto}
  .card{background:var(--card);border-radius:14px;padding:16px}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #374151;background:#0b1020;color:var(--text)}
  button{border:0;background:#2563eb;font-weight:700;margin-top:12px;cursor:pointer}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kpi{display:grid;grid-template-columns:1fr auto;gap:6px;padding:10px;border-radius:10px;background:#0b1020;margin-top:10px}
  .kpi b{font-size:16px}
  .foot{margin-top:10px;font-size:12px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <h1>BTC Up/Down Helper</h1>
  <div class="card">
    <div class="row">
      <div class="kpi"><span>BTC (USDT)</span><b id="btcPrice">â€”</b></div>
      <div class="kpi"><span>Minutes Left (ET)</span><b id="minsLeft">â€”</b></div>
    </div>

    <div class="kpi"><span>Price to Beat (1h open)</span><b id="ptb">â€”</b></div>
    <div class="kpi"><span>Gap to Beat ($)</span><b id="gapUSD">â€”</b></div>

    <div class="kpi"><span>Volatility / min</span><b id="volMin">â€”</b></div>
    <div class="kpi"><span>Expected Move</span><b id="expMove">â€”</b></div>

    <label>Current Up Price (from Polymarket)</label>
    <input id="upPrice" type="number" step="0.01" placeholder="e.g. 0.62 (62Â¢)" />
    <button id="calcBtn">Calculate</button>

    <div class="row">
      <div class="kpi"><span>Up %</span><b id="upPct">â€”</b></div>
      <div class="kpi"><span>Down %</span><b id="downPct">â€”</b></div>
    </div>
    <div class="kpi"><span>Signal</span><b id="signal">â€”</b></div>

    <div class="foot" id="stamp">â€”</div>
    <div class="foot">Data: Binance (public). Times computed in America/New_York (ET).</div>
  </div>
</div>

<script>
const { DateTime } = luxon;
const fmt = (n,d=2)=>Number.isFinite(n)?n.toFixed(d):"â€”";

/* ======== STATE ======== */
let state = {
  price: null,    // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† WebSocket
  ptb: null,      // Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØªØ§Ø­ Ù„Ù„Ø³Ø§Ø¹Ø© Ø¨ØªÙˆÙ‚ÙŠØª ET
  volMin: null,   // ØªØ°Ø¨Ø°Ø¨ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±/Ø¯Ù‚ÙŠÙ‚Ø© (ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ high-low/ Ø¯Ù‚Ø§Ø¦Ù‚)
  minsLeft: 0,    // Ø¯Ù‚Ø§Ø¦Ù‚ Ù…ØªØ¨Ù‚ÙŠØ© Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ø§Ø¹Ø© (ET)
  currHourStartUTCms: null,
  lastVolMinute: null
};

/* ======== TIME (ET) ======== */
function getHourWindowET(){
  const nowET   = DateTime.now().setZone('America/New_York');
  const startET = nowET.startOf('hour');
  const endET   = startET.plus({hours:1});
  const startMsUTC = startET.toUTC().toMillis();
  const minsLeft = Math.max(0, Math.floor(endET.diff(nowET,'minutes').minutes));
  return {startMsUTC, minsLeft};
}

/* ======== FETCHERS ======== */
async function fetchHourOpen(startMs){
  const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1h&startTime=${startMs}&limit=1`;
  const r = await fetch(url);
  const j = await r.json();
  return (Array.isArray(j) && j.length) ? parseFloat(j[0][1]) : null; // open
}

async function fetchVolPerMin(lookbackMins){
  const n = Math.max(1, Math.min(1000, lookbackMins||15));
  const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=${n}`;
  const r = await fetch(url);
  const d = await r.json();
  if(!Array.isArray(d)||!d.length) return null;
  const highs = d.map(c=>+c[2]), lows = d.map(c=>+c[3]);
  const range = (Math.max(...highs)-Math.min(...lows));
  return range / Math.max(1,(lookbackMins||15)); // $/min ØªÙ‚Ø±ÙŠØ¨ÙŠ
}

/* ======== FAIR/EM ======== */
function computeFairAndEM(){
  const {price, ptb, minsLeft, volMin} = state;
  const expectedMove = (volMin??0) * Math.max(1, minsLeft || 1); // $
  const gapImpact = expectedMove ? (ptb - price)/expectedMove : 0;
  let fairUp = Math.max(0, Math.min(1, 0.5 + gapImpact/100));
  const fairDown = 1 - fairUp;

  const upM = parseFloat(document.getElementById('upPrice').value);
  const m = isNaN(upM) ? 0.5 : upM;
  const diff = fairUp - m;
  let signal = "âšª Neutral";
  if (diff > 0.15) signal = "ğŸŸ¢ Buy Up";
  else if (diff < -0.15) signal = "ğŸ”´ Sell Up";

  return {
    expectedMove,
    fairUpPct: +(fairUp*100).toFixed(1),
    fairDownPct: +(fairDown*100).toFixed(1),
    signal
  };
}

/* ======== RENDER ======== */
function render(){
  // Minutes Left (ET): ØªÙØ­Ø¯Ù‘Ø« ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
  document.getElementById('minsLeft').textContent = state.minsLeft;

  // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (WebSocket)
  document.getElementById('btcPrice').textContent = fmt(state.price,2);

  // Price to Beat
  document.getElementById('ptb').textContent = state.ptb!=null ? fmt(state.ptb,2) : 'â€”';

  // Gap to Beat ($)
  const gap = (state.ptb!=null && state.price!=null) ? (state.ptb - state.price) : null;
  document.getElementById('gapUSD').textContent = (gap==null) ? 'â€”' : ((gap>=0?'+':'')+fmt(gap,2));

  // Vol / min Ùˆ Expected Move Ùˆ Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª
  if(state.volMin!=null && state.price!=null && state.ptb!=null){
    const {expectedMove, fairUpPct, fairDownPct, signal} = computeFairAndEM();
    document.getElementById('volMin').textContent = fmt(state.volMin,3);
    document.getElementById('expMove').textContent = fmt(expectedMove,3);
    document.getElementById('upPct').textContent = fairUpPct + '%';
    document.getElementById('downPct').textContent = fairDownPct + '%';
    document.getElementById('signal').textContent = signal;
  }

  const t = new Date().toISOString().replace('T',' ').slice(0,19);
  document.getElementById('stamp').textContent = `Last update: ${t} UTC | Open = Binance 1h @ ET hour start`;
}

/* ======== LIVE PRICE (WebSocket) ======== */
function startPriceWS(){
  try{
    const ws = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@trade");
    ws.onmessage = (ev)=>{
      const data = JSON.parse(ev.data);
      const price = parseFloat(data.p);
      if(Number.isFinite(price)){
        state.price = price;
        // ÙƒÙ„ ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø±: Ø£Ø¹ÙØ¯Ù‘ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©/Ø§Ù„ÙØ¬ÙˆØ© Ø³Ø±ÙŠØ¹Ù‹Ø§
        render();
      }
    };
    ws.onclose = ()=> setTimeout(startPriceWS, 1500);
  }catch(e){
    console.error('WS error', e);
    setTimeout(startPriceWS, 3000);
  }
}

/* ======== SCHEDULERS ======== */

// 1) Ø­Ø¯Ù‘Ø« Minutes Left ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© + Ù„Ùˆ ØªØºÙŠØ±Øª Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ø¬Ù„Ø¨ PTB Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
async function everySecond(){
  const {startMsUTC, minsLeft} = getHourWindowET();
  state.minsLeft = minsLeft;

  if (state.currHourStartUTCms !== startMsUTC){
    state.currHourStartUTCms = startMsUTC;
    state.ptb = await fetchHourOpen(startMsUTC);
  }
  render();
}

// 2) Ø­Ø¯Ù‘Ø« Volatility/min ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© (Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø¯Ù‚Ø§Ø¦Ù‚ Ù…ØªØ§Ø­Ø© Ø£Ùˆ minsLeft)
async function everyMinute(){
  const nowMin = Math.floor(Date.now()/60000);
  if (state.lastVolMinute === nowMin) return;
  state.lastVolMinute = nowMin;

  // Ø§Ø³ØªØ®Ø¯Ù… Ù†Ø§ÙØ°Ø© = min(60, max(10, minsLeft)) Ù…Ø«Ù„Ø§Ù‹
  const lookback = Math.max(10, Math.min(60, state.minsLeft || 15));
  const v = await fetchVolPerMin(lookback);
  if (v!=null) state.volMin = v;
  render();
}

/* ======== BOOT ======== */
document.getElementById('calcBtn').addEventListener('click', render);

(async function boot(){
  // ØªÙ‡ÙŠØ¦Ø© PTB Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
  const {startMsUTC, minsLeft} = getHourWindowET();
  state.currHourStartUTCms = startMsUTC;
  state.minsLeft = minsLeft;
  state.ptb = await fetchHourOpen(startMsUTC);

  // Ø¬Ù„Ø¨ Ø£ÙˆÙ„ÙŠ Ù„Ù„ØªØ°Ø¨Ø°Ø¨
  state.volMin = await fetchVolPerMin(Math.max(10, Math.min(60, state.minsLeft || 15)));

  // Ø´ØºÙ‘Ù„ WebSocket Ù„Ù„Ø³Ø¹Ø±
  startPriceWS();

  // Ù…Ø¤Ù‚Ù‘Øª ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Minutes Left + PTB Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø³Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
  setInterval(everySecond, 1000);

  // Ù…Ø¤Ù‚Ù‘Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ù„ØªØ­Ø¯ÙŠØ« Vol/min
  setInterval(everyMinute, 5_000); // Ù†Ø±Ø§Ù‚Ø¨ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ ÙˆÙ†Ø¹ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©

  render();
})();
</script>
</body>
</html>
